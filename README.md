# 🎤 商談録音アプリ - セットアップガイド

## 📋 概要

- **録音時間**: 最大60分
- **自動文字起こし**: Gemini API (api_bank経由)
- **保存先**: Google Drive
- **特徴**: 音声データは一時保存のみ、文字起こし後に自動削除

---

## 🚀 セットアップ手順

### 1. Google Cloud Platform設定（完了済み）

✅ プロジェクト作成: `biz-record`
✅ Google Drive API有効化
✅ OAuth 2.0認証情報作成
✅ クライアントID取得

---

### 2. Google Driveフォルダ準備（完了済み）

```
マイドライブ/
└── biz-record/
    ├── voice/  (ID: 1Drp4_rkJsLpdC49tzRDACcCnQb_ywl4h)
    └── doc/    (ID: 11gbAyd8kdgZN8bD29PDAm32B0LuboVtq)
```

---

### 3. ファイルをWebサーバーに配置

以下のファイルを同じディレクトリに配置してください：

```
biz-record/
├── index.html      ← メイン画面
├── app.js          ← 録音・アップロード処理
└── manifest.json   ← PWA設定
```

#### ローカルテスト用サーバー起動

```bash
# Python 3の場合
python3 -m http.server 8080

# Python 2の場合
python -m SimpleHTTPServer 8080

# Node.jsの場合
npx http-server -p 8080
```

ブラウザで `http://localhost:8080` にアクセス

---

### 4. Google Apps Script設定

#### 4-1. GASプロジェクト作成

1. https://script.google.com/ にアクセス
2. 「新しいプロジェクト」をクリック
3. プロジェクト名: `商談録音アプリ - 文字起こし`

#### 4-2. コードを貼り付け

`transcription.js` の内容をコピーして、GASエディタに貼り付けてください。

#### 4-3. BANK_URL を設定

**重要**: `transcription.js` の以下の部分を実際のapi_bank URLに変更してください：

```javascript
const CONFIG = {
  BANK_URL: 'https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID/exec', // ← ここを変更
  BANK_PASS: '1030013',
  PROJECT_NAME: 'biz-record',
  // ...
};
```

#### 4-4. トリガー設定

1. GASエディタで「トリガー」アイコン（時計マーク）をクリック
2. 「トリガーを追加」をクリック
3. 以下のように設定：
   - **実行する関数**: `processVoiceFiles`
   - **イベントのソース**: `時間主導型`
   - **時間ベースのトリガー**: `分ベースのタイマー`
   - **時間の間隔**: `1分ごと`
4. 「保存」をクリック

#### 4-5. 初回実行＆権限承認

1. GASエディタで「実行」ボタンをクリック
2. 権限承認画面が表示されるので、承認してください
3. ログに「=== 処理完了: 0件 ===」と表示されればOK

---

## 📱 使い方

### アプリを開く

1. ブラウザまたはスマホで `http://localhost:8080` にアクセス
   - **本番環境**: サーバーに配置後、実際のURLにアクセス

2. 「Google アカウントで認証」ボタンをクリック

3. Google認証画面で：
   - アカウントを選択
   - 権限を承認

---

### 録音開始

1. 「録音開始」ボタンをタップ
2. マイク使用の許可を求められたら「許可」
3. 録音が開始されます

**自動処理**:
- 5分ごとに音声チャンクが自動アップロード
- アップロード完了後、ローカルの音声データは即削除
- 最大60分まで録音可能

---

### 録音停止

1. 「録音停止」ボタンをタップ
2. 最後のチャンクがアップロードされて完了

---

### ⚠️ アップロード失敗時の対応

万が一、アップロードに失敗した場合（電波不良など）、以下の救済措置が発動します：

1. **自動ダウンロード**: 失敗した音声ファイル（.webm）が端末に自動保存されます。
2. **手動アップロード**: 画面下部の「📁 ファイルを選択してアップロード」ボタンから、保存されたファイルをアップロードしてください。

**注意**:
- ファイル名（例: `240201_143000_chunk01.webm`）は**変更しないで**ください。
- 変更するとGAS側で認識できず、文字起こしされません。

---

### 文字起こし確認

1. Google Driveの `biz-record/doc/` フォルダを開く
2. `YYMMDD_01.txt` 形式のファイルが作成されています
   - 例: `260201_01.txt` (2026年2月1日の1件目)
3. ファイルを開いて文字起こし結果を確認

---

## ⚙️ 技術仕様

### 音声形式

- **形式**: WebM (Opus codec)
- **ビットレート**: 128kbps
- **サンプルレート**: 48kHz
- **ファイルサイズ**: 約2-3MB / 5分

### チャンク分割

- **チャンク時間**: 5分
- **最大チャンク数**: 12個（60分）
- **ファイル名形式**: `YYMMDD_HHmmss_chunkXX.webm`

### アップロード

- **API**: Google Drive API v3
- **方式**: マルチパートアップロード
- **並列処理**: 録音とアップロードが並行実行
- **失敗対策**: 自動ダウンロード＆手動再アップロード機能

### 文字起こし

- **エンジン**: Gemini API (via api_bank)
- **モデル**: 自動選択（負荷分散）
- **503エラー対応**: 最大3回リトライ
- **処理間隔**: 1分ごとに自動実行 (タイムアウト: 300秒)

---

## 🔧 トラブルシューティング

### 認証エラー

**症状**: 「認証エラー」と表示される

**原因**:
- OAuth 2.0設定が正しくない
- JavaScript生成元 / リダイレクトURIの設定ミス

**解決策**:
1. Google Cloud Consoleで認証情報を確認
2. 承認済みのJavaScript生成元に現在のURLを追加
3. 承認済みのリダイレクトURIに `現在のURL/oauth2callback` を追加

---

### 録音が途中で止まる

**症状**: 5分経過後に録音が停止する

**原因**:
- ブラウザがバックグラウンドになった
- スマホがスリープモードになった

**解決策**:
- 画面を点けたままにする
- ブラウザをフォアグラウンドで実行

---

### 文字起こしされない

**症状**: docフォルダにファイルが作成されない

**確認事項**:
1. GASのトリガーが正しく設定されているか
2. `transcription.js` の `BANK_URL` が正しいか
3. voiceフォルダに音声ファイルがあるか
4. GASの実行ログを確認（エラーメッセージ）

**ログ確認方法**:
1. GASエディタで「実行」→「processVoiceFiles」
2. 「ログ」タブでエラーを確認

---

### アップロードが失敗する

**症状**: 「アップロード失敗」と表示される

**原因**:
- ネットワーク接続が不安定
- アクセストークンの有効期限切れ

**解決策**:
1. 自動保存されたファイルを確認する
2. 画面下部の手動アップロードボタンを使用する
3. ファイル名は変更しないこと

---

## 📊 システムフロー

```
【録音開始】
    ↓
【5分ごとにチャンク生成】
    ↓
【Google Driveにアップロード (voice/)】
    ↓
【ローカル音声データ削除】
    ↓
【GASトリガー起動（1分ごと）】
    ↓
【voiceフォルダをスキャン】
    ↓
【新しい音声ファイル検出】
    ↓
【api_bank経由でGemini API呼び出し】
    ↓
【文字起こし実行】
    ↓
【テキストをdocフォルダに保存】
    ↓
【音声ファイル削除】
    ↓
【全チャンク完了後、テキスト結合】
    ↓
【最終ファイル作成 (YYMMDD_01.txt)】
```

---

## 🔒 セキュリティとプライバシー

### データの取り扱い

- **音声データ**: 一時的にGoogle Driveに保存、文字起こし後に自動削除
- **テキストデータ**: Google Driveの`doc/`フォルダに永続保存
- **ローカルストレージ**: 使用しません

### 権限

- **Google Drive**: アプリが作成したファイルのみにアクセス可能
- **マイク**: 録音時のみ使用

---

## 🆘 サポート

問題が解決しない場合は、以下の情報を添えてお問い合わせください：

1. ブラウザ / OSのバージョン
2. エラーメッセージ
3. GASの実行ログ
4. 発生した日時

---

**Happy Recording! 🎤**